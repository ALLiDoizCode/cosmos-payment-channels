# CosmWasm Payment Channels

CosmWasm Payment Channels for Nostr-ILP Integration

## Overview

This repository contains a CosmWasm smart contract implementation for payment channels on Cosmos/Akash networks. The contract enables native AKT payments without wrapping or bridging, designed to integrate with the Dassie ILP settlement module.

## Project Status

ðŸš§ **In Development** - Initial project setup in progress

## Prerequisites

- Rust 1.70+ (tested with 1.91.1)
- wasm32-unknown-unknown target
- cargo-generate (v0.23.7)
- cargo-wasm (v0.4.1)

## Dependencies

- **cosmwasm-std** v2.2.2 - CosmWasm standard library
- **cosmwasm-schema** v2.2.2 - JSON schema generation
- **cw-storage-plus** v2.0.0 - Enhanced storage patterns
- **cw2** v2.0.0 - Contract metadata
- **schemars** v0.8.22 - JSON schema derivation
- **serde** v1.0.197 - Serialization framework
- **thiserror** v1.0.69 - Error handling

### Dev Dependencies
- **cw-multi-test** v2.5.1 - Integration testing framework

## Quick Start

```bash
# Clone repository
git clone https://github.com/YOUR_USERNAME/cosmos-payment-channels.git
cd cosmos-payment-channels

# Build contract
cargo build

# Run tests
cargo test

# Generate schemas
cargo run --example schema

# Compile to WASM
cargo wasm
```

## Architecture

This contract implements payment channels with the following entry points:
- `instantiate` - Initialize contract state on deployment
- `execute` - State-changing operations (future: open_channel, close_channel)
- `query` - Read-only queries (future: get_channel, list_channels)
- `migrate` - Contract upgrade logic (optional)

**Current Template Implementation:**
This project currently contains the CosmWasm template "Counter" contract as a foundation. Future stories (3.2-3.4) will replace this with payment channel logic.

### Contract Entry Points

```rust
#[entry_point]
pub fn instantiate(deps: DepsMut, env: Env, info: MessageInfo, msg: InstantiateMsg)
#[entry_point]
pub fn execute(deps: DepsMut, env: Env, info: MessageInfo, msg: ExecuteMsg)
#[entry_point]
pub fn query(deps: Deps, env: Env, msg: QueryMsg)
```

## Integration with Dassie

This contract will be consumed by the Dassie Cosmos settlement module (Story 2.7, already complete) to enable ILP payments on Akash/Cosmos chains.

**Integration Flow:**
```
Dassie Settlement Module (TypeScript)
  â†“
CosmJS (@cosmjs/cosmwasm-stargate)
  â†“
Payment Channel Contract (Rust/WASM)
  â†“
Akash Blockchain
```

The JSON schemas generated by this project will be imported into the Dassie settlement module for type-safe contract interactions.

## Development

### Build Contract (Development)
```bash
cargo build
```

This compiles the contract for development/testing (not WASM).

### Compile to WebAssembly
```bash
cargo build --lib --target wasm32-unknown-unknown --release
```

Output: `target/wasm32-unknown-unknown/release/payment_channel.wasm` (321KB unoptimized)

**Note:** Use `--lib` flag to exclude binary targets (schema generator) from WASM compilation.

### Run Unit Tests
```bash
cargo test
```

This runs all unit tests (4 tests from template):
- `proper_initialization` - Tests contract instantiation
- `increment` - Tests execute message handling
- `reset` - Tests authorization and state updates
- `integration_tests::count` - Tests full contract lifecycle with cw-multi-test

### Generate JSON Schemas
```bash
cargo run --bin schema
```

Generates JSON schemas in `schema/` directory:
- `payment-channel.json` - Combined API schema
- `raw/instantiate.json` - InstantiateMsg schema
- `raw/execute.json` - ExecuteMsg schema
- `raw/query.json` - QueryMsg schema

These schemas can be used to generate TypeScript types for client libraries.

### Code Quality

**Format Code:**
```bash
cargo fmt
```

**Lint with Clippy:**
```bash
cargo clippy -- -D warnings
```

**Run All Checks (CI equivalent):**
```bash
cargo fmt -- --check
cargo clippy --all-targets -- -D warnings
cargo test
cargo build --lib --target wasm32-unknown-unknown --release
cargo run --bin schema
```

## Development Workflow

1. Make changes to contract code in `src/`
2. Run `cargo fmt` to format code
3. Run `cargo clippy` to check for issues
4. Run `cargo test` to verify tests pass
5. Run `cargo build --lib --target wasm32-unknown-unknown --release` to build WASM
6. Run `cargo run --bin schema` to regenerate schemas if message types changed
7. Commit changes with descriptive message

## Continuous Integration

This project uses GitHub Actions for CI/CD. The workflow runs on every push and PR:

- âœ… Format check (`cargo fmt`)
- âœ… Linting (`cargo clippy`)
- âœ… Unit tests (`cargo test`)
- âœ… WASM build (with size check < 1MB)
- âœ… Schema generation

See `.github/workflows/rust.yml` for details.

## Future Stories

This project will be extended in upcoming stories:

- **Story 3.2**: Define payment channel state and message types
- **Story 3.3**: Implement `open_channel` logic
- **Story 3.4**: Implement `close_channel` with signature verification
- **Story 3.5**: Implement channel query endpoints
- **Story 3.6**: Deploy to Akash testnet
- **Story 3.7**: Create TypeScript client library using generated schemas

## License

Apache 2.0

## Contributing

Contributions welcome! Please open an issue or PR.

### Coding Standards

- Follow Rust naming conventions (snake_case for functions, PascalCase for types)
- Add tests for all new functionality
- Update schemas when message types change
- Keep WASM binary size under 1MB (unoptimized)
